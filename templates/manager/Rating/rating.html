{% load static %}
<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title >Davomat Tizimi</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}">

<style>
/* Subheader container */
.subheader {
    background-color: white; /* engil gray */
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    border-radius: 15px;
    margin-bottom: 15px;
}

/* Fluid container */
.subheader .container-fluid {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: flex-start; /* chapdan boshlanadi */
    gap: 1rem;
}

/* Nav tabs */
.subheader .nav-tabs {
    display: flex;
    gap: 0.5rem;
    list-style: none;
    padding: 0;
    margin: 0;
}

/* Nav item links */
.subheader .nav-tabs .nav-link {
    display: inline-block;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280; /* gray */
    border-radius: 6px;
    text-decoration: none;
    transition: all 0.2s;
    background-color: #e5e7eb20; /* yengil hover fon */
}

/* Hover effect */
.subheader .nav-tabs .nav-link:hover {
    background-color: #e5e7eb;
    color: #3b82f6; /* dark gray */
}

/* Active tab */
.subheader .nav-tabs .active {
    background-color: #3b82f6; /* primary blue */
    color: white;
    font-weight: 600;
}

/* Responsive: kichik ekranlarda vertical bo‚Äòlsin */
@media (max-width: 576px) {
    .subheader .nav-tabs {
        flex-direction: column;
        gap: 0.25rem;
    }

    .subheader .nav-tabs .nav-link {
        text-align: center;
    }
}
/* Month/Year Select Styles */
#month-select, #year-select {
    border: none;
    border-bottom: 2px solid #d1d5db;
    background: transparent;
    color: #374151;
    font-weight: 500;
    padding: 8px 4px;
    transition: all 0.3s;
    width: 150px;
}

#month-select:focus, #year-select:focus {
    border-bottom-color: #2563eb;
    outline: none;
}

#month-select:hover, #year-select:hover {
    border-bottom-color: #3b82f6;
}

/* Responsive */
@media (max-width: 768px) {
    .subheader .container-fluid {
        flex-direction: column;
        gap: 12px;
        padding: 12px 16px;
    }
    
    .nav-tabs {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .nav-tabs .nav-link {
        white-space: nowrap;
        padding: 12px 16px;
    }
}
</style>

</head>
<body>
    <div class="container">
        <div class="max-width">
            <!--begin::Subheader-->
            <div class="subheader py-2 py-lg-4 subheader-solid" id="kt_subheader">
                <div class="container-fluid d-flex align-items-center justify-content-between flex-wrap flex-sm-nowrap">
                    <!--begin::Info-->
                    <ul class="nav nav-tabs">
                        <li class="nav-item">
                            <a class="nav-link {% if active_tab == 'all' %}active{% endif %}" href="{% url 'manager:group-settings' group.pk %}">All</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if active_tab == 'attendance' %}active{% endif %}" href="{% url 'manager:attendance-list' group.pk %}">Davomat</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if active_tab == 'baholash' %}active{% endif %}" href="{% url 'manager:grade-view' group.id %}">Baholash</a>
                        </li>
                    </ul>
                    <!--end::Info-->
                </div>
            </div>
            <!--end::Subheader-->
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <div class="header-title">
                        <h1>Rating system</h1>
                        <p>{{ group.title }} - O'quvchilar baholashni boshqarish</p>
                    </div>
                    <div class="header-stats">
                        <div class="stat-item">
                            <div class="stat-dot emerald"></div>
                            <span id="student-count">Yuklanmoqda...</span>
                        </div>
                        <div class="stat-item">
                            <div class="stat-dot blue"></div>
                            <span id="lesson-count">0 kun</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="controls-grid">
                    <!-- Month and Year Selection -->
                    <div class="control-group">
                        <label>Oy va yil tanlash</label>
                        <div class="input-group">
                            <select id="month-select">
                                <option value="0">Yanvar</option>
                                <option value="1">Fevral</option>
                                <option value="2">Mart</option>
                                <option value="3">Aprel</option>
                                <option value="4">May</option>
                                <option value="5">Iyun</option>
                                <option value="6">Iyul</option>
                                <option value="7">Avgust</option>
                                <option value="8">Sentabr</option>
                                <option value="9">Oktabr</option>
                                <option value="10">Noyabr</option>
                                <option value="11">Dekabr</option>
                            </select>
                            <select id="year-select"></select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-state" style="text-align: center; padding: 40px; color: #666;">
                <p>Talabalar yuklanmoqda...</p>
            </div>

            <!-- Attendance Table -->
            <div class="table-container" id="table-container" style="display: none;">
                <div id="table-content">
                    <!-- Table will be generated by JavaScript -->
                </div>
            </div>
        </div>
    </div>


<script>
    const groupId = '{{ group.id }}';
    const lessonDays = "{{ group.lesson_days }}";
    let students = [];
    let attendance = {};
    let lessonDates = [];
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    document.addEventListener('DOMContentLoaded', function() {
        initializeYearSelect();
        setCurrentDate();
        loadStudentsFromAPI();
    });

    async function loadStudentsFromAPI() {
        try {
            const response = await fetch(`/manager/api/groups/${groupId}/students/`);
            if (!response.ok) throw new Error(`API xatolik: ${response.status}`);
            const apiStudents = await response.json();

            students = apiStudents.map(s => ({
                id: s.id,
                name: s.full_name,
                joinDate: new Date().toISOString().split('T')[0]
            }));

            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('table-container').style.display = 'block';

            updateLessonDates();
            await loadExistingAttendance();
            renderTable();
            updateStats();
        } catch (error) {
            document.getElementById('loading-state').innerHTML = `<p style="color:red;">‚ùå ${error.message}</p>`;
        }
    }

    async function loadExistingAttendance() {
        try {
            const startDate = new Date(currentYear, currentMonth, 1).toISOString().split('T')[0];
            const endDate = new Date(currentYear, currentMonth + 1, 0).toISOString().split('T')[0];
            const response = await fetch(`/manager/api/attendance/?group=${groupId}&start_date=${startDate}&end_date=${endDate}`);

            if (response.ok) {
                const data = await response.json();
                data.forEach(item => {
                    const date = item.date_time.split('T')[0];
                    const key = `${item.student}-${date}`;
                    attendance[key] = item.is_present ? 5 : 1;
                });
            }
        } catch (error) {
            console.error('Davomat yuklashda xato:', error);
        }
    }

    function initializeYearSelect() {
        const y = document.getElementById('year-select');
        for (let i = 2020; i <= 2030; i++) {
            const o = document.createElement('option');
            o.value = i; o.textContent = i; y.appendChild(o);
        }
    }

    function setCurrentDate() {
        document.getElementById('month-select').value = currentMonth;
        document.getElementById('year-select').value = currentYear;
    }

    document.getElementById('month-select').addEventListener('change', reloadMonth);
    document.getElementById('year-select').addEventListener('change', reloadMonth);

    async function reloadMonth() {
        currentMonth = parseInt(document.getElementById('month-select').value);
        currentYear = parseInt(document.getElementById('year-select').value);
        updateLessonDates();
        await loadExistingAttendance();
        renderTable();
        updateStats();
    }

    function getLessonDaysNumbers() {
        const dayMap = { mo: 1, tu: 2, we: 3, thu: 4, fri: 5, sa: 6 };
        return lessonDays.toLowerCase().split(' ').map(d => dayMap[d]).filter(Boolean);
    }

    function getWeekdays(month, year) {
        const dates = [];
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const allowed = getLessonDaysNumbers();

        for (let d = 1; d <= daysInMonth; d++) {
            const date = new Date(year, month, d);
            if (allowed.includes(date.getDay())) {
                dates.push({
                    date: date.toISOString().split('T')[0],
                    display: `${String(d).padStart(2,'0')}.${String(month+1).padStart(2,'0')}`,
                });
            }
        }
        return dates;
    }

    function updateLessonDates() {
        lessonDates = getWeekdays(currentMonth, currentYear);
        students.forEach(s => {
            lessonDates.forEach(d => {
                const key = `${s.id}-${d.date}`;
                if (!(key in attendance)) attendance[key] = null;
            });
        });
    }

    function markAttendance(studentId, date, value) {
        const num = parseInt(value);
        if (isNaN(num) || num < 1 || num > 5) return;
        const key = `${studentId}-${date}`;
        attendance[key] = num;
        colorizeInput(document.querySelector(`[data-key="${key}"]`), num);
        renderTable(); // jadvalni yangilash
        updateStats();
    }

    function colorizeInput(input, value) {
        if (!input) return;
        if (value <= 2) input.style.background = '#ff6b6b';
        else if (value === 3) input.style.background = '#ffd93b';
        else if (value >= 4) input.style.background = '#81c784';
        else input.style.background = '#fff';
    }

    // üìä O‚Äòrtacha ball hisoblash
    function getAverageScore(studentId) {
        const scores = Object.entries(attendance)
            .filter(([key]) => key.startsWith(`${studentId}-`))
            .map(([, val]) => parseFloat(val))
            .filter(v => !isNaN(v));

        if (scores.length === 0) return 0;
        const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
        return avg.toFixed(1);
    }

    function renderTable() {
        const tableContent = document.getElementById('table-content');
        if (students.length === 0) {
            tableContent.innerHTML = `<p>‚ùå O'quvchilar topilmadi</p>`;
            return;
        }

        const today = new Date();
        const isCurrentMonth = (
            today.getMonth() === currentMonth &&
            today.getFullYear() === currentYear
        );

        let html = `
        <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>O'quvchi</th>
                    ${lessonDates.map(d => `<th>${d.display}</th>`).join('')}
                    <th>O‚Äòrtacha</th>
                </tr>
            </thead>
            <tbody>
        `;

        students.forEach((s, i) => {
            const avg = getAverageScore(s.id);
            html += `<tr style="background:${i%2?'#fafafa':'white'};">
                <td>${s.name}</td>
                ${lessonDates.map(d => {
                    const key = `${s.id}-${d.date}`;
                    const val = attendance[key] || '';
                    const dateObj = new Date(d.date);
                    const isPast = (dateObj < today && (currentMonth < today.getMonth() || currentYear < today.getFullYear()));

                    if (isPast) {
                        return `<td style="text-align:center; color:#999;">-</td>`;
                    }

                    return `
                        <td style="text-align:center;">
                            <input 
                                type="text" maxlength="1" pattern="[1-5]" 
                                data-key="${key}"
                                value="${val}"
                                oninput="this.value=this.value.replace(/[^1-5]/g,''); markAttendance(${s.id}, '${d.date}', this.value)"
                                style="width:35px; height:35px; text-align:center; font-weight:bold; border:1px solid #ccc; border-radius:6px; outline:none; transition:0.3s;">
                        </td>`;
                }).join('')}
                <td style="text-align:center; font-weight:bold;">${avg}</td>
            </tr>`;
        });

        html += `</tbody></table></div>`;
        tableContent.innerHTML = html;

        // ranglarni yangilab chiqamiz
        document.querySelectorAll('input[data-key]').forEach(input => {
            colorizeInput(input, parseInt(input.value));
        });
    }

    function updateStats() {
        document.getElementById('student-count').textContent = `${students.length} o'quvchi`;
        document.getElementById('lesson-count').textContent = `${lessonDates.length} kun`;
    }
</script>





</body>
</html>