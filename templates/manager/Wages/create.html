{% extends "base/base.html" %}
{% load static %}
{% block content %}
<body id="kt_body"
    class="header-fixed header-mobile-fixed subheader-enabled subheader-fixed aside-enabled aside-fixed aside-minimize-hoverable page-loading">

    {% include "parts/header-mobile.html" %}

    <div class="d-flex flex-column flex-root">
        <div class="d-flex flex-row flex-column-fluid page">
            {% include "parts/aside.html" with menu_parent="employee-all" menu_child="wage-create" %}

            <div class="d-flex flex-column flex-row-fluid wrapper" id="kt_wrapper">
                {% include "parts/header.html" %}
                
                <div class="content d-flex flex-column flex-column-fluid" id="kt_content">
                    <div class="d-flex flex-column-fluid">
                        <div class="container">
                            <div class="card card-custom card-sticky" id="kt_page_sticky_card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <h3 class="card-label">Create Wage (Ish Haqi)</h3>
                                    </div>
                                </div>

                                <div class="card-body">
                                    <form class="form" method="post" id="wageForm">
                                        {% csrf_token %}

                                        <!-- Role -->
                                        <div class="form-group row">
                                            <label class="col-form-label col-lg-3">Role</label>
                                            <div class="col-lg-9">
                                                <select id="id_role" name="role" class="form-control" required>
                                                    <option value="">--- Select Role ---</option>
                                                    {% for value, label in roles %}
                                                        <option value="{{ value }}">{{ label }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Employee -->
                                        <div class="form-group row">
                                            <label class="col-form-label col-lg-3">Employee (Hodim)</label>
                                            <div class="col-lg-9">
                                                <select id="id_employee" name="employee" class="form-control" disabled required>
                                                    <option value="">--- Select Employee ---</option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Salary info -->
                                        <div class="form-group row" id="salary-info" style="display: none;">
                                            <label class="col-lg-3"></label>
                                            <div class="col-lg-9">
                                                <span style="color:red; font-weight:bold;">
                                                    Monthly Salary: <span id="salary_amount"></span> so'm
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Amount -->
                                        <div class="form-group row">
                                            <label class="col-form-label col-lg-3">Amount</label>
                                            <div class="col-lg-9">
                                                <input type="number" name="amount" class="form-control" placeholder="Enter amount..." required>
                                            </div>
                                        </div>

                                        <!-- Date -->
                                        <div class="form-group row">
                                            <label class="col-form-label col-lg-3">Date</label>
                                            <div class="col-lg-9">
                                                <input type="date" name="date" class="form-control" required>
                                            </div>
                                        </div>

                                        <!-- Form actions -->
                                        <div class="card-footer">
                                            <div class="row">
                                                <div class="col-lg-3"></div>
                                                <div class="col-lg-9">
                                                    <button type="submit" class="btn btn-primary mr-2">Save</button>
                                                    <a href="{% url 'manager:wages-list' %}" class="btn btn-secondary">Cancel</a>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                {% include "parts/footer.html" %}
            </div>
        </div>
    </div>

    {% include "parts/user-panel.html" %}
    {% include "parts/scrolltop.html" %}

    <!-- AJAX script -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {

            // Role tanlanganda employee select yangilanadi
            $('#id_role').change(function () {
                var role = $(this).val();
                var employeeSelect = $('#id_employee');

                if (role) {
                    $.ajax({
                        url: "{% url 'manager:get-employees-by-role' %}",
                        data: { role: role },
                        dataType: 'json',
                        success: function (data) {
                            employeeSelect.empty().append('<option value="">--- Select Employee ---</option>');

                            $.each(data.employees, function (index, employee) {
                                employeeSelect.append(
                                    $('<option>', {
                                        value: employee.id,
                                        text: employee.full_name,
                                        'data-salary': employee.salary
                                    })
                                );
                            });

                            employeeSelect.prop('disabled', false);
                            $('#salary-info').hide();
                        },
                        error: function() {
                            employeeSelect.prop('disabled', true);
                            employeeSelect.empty().append('<option value="">--- Select Employee ---</option>');
                            $('#salary-info').hide();
                        }
                    });
                } else {
                    employeeSelect.prop('disabled', true);
                    employeeSelect.empty().append('<option value="">--- Select Employee ---</option>');
                    $('#salary-info').hide();
                }
            });

            // Employee tanlanganda salary ko'rsatiladi
            $('#id_employee').change(function () {
                var salary = $('option:selected', this).data('salary');
                if (salary) {
                    $('#salary_amount').text(salary);
                    $('#salary-info').show();
                } else {
                    $('#salary-info').hide();
                }
            });

            // Form yuborilganda employee select ni yoqish
            $('#wageForm').on('submit', function() {
                $('#id_employee').prop('disabled', false);
            });

        });
    </script>

</body>
{% endblock %}