{% load static %}
<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Davomat Tizimi</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
    <div class="container">
        <div class="max-width">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <div class="header-title">
                        <h1>Davomat Tizimi</h1>
                        <p>{{ group.name }} - O'quvchilar davomatini boshqarish</p>
                    </div>
                    <div class="header-stats">
                        <div class="stat-item">
                            <div class="stat-dot emerald"></div>
                            <span id="student-count">Yuklanmoqda...</span>
                        </div>
                        <div class="stat-item">
                            <div class="stat-dot blue"></div>
                            <span id="lesson-count">0 kun</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="controls-grid">
                    <!-- Month and Year Selection -->
                    <div class="control-group">
                        <label>Oy va yil tanlash</label>
                        <div class="input-group">
                            <select id="month-select">
                                <option value="0">Yanvar</option>
                                <option value="1">Fevral</option>
                                <option value="2">Mart</option>
                                <option value="3">Aprel</option>
                                <option value="4">May</option>
                                <option value="5">Iyun</option>
                                <option value="6">Iyul</option>
                                <option value="7">Avgust</option>
                                <option value="8">Sentabr</option>
                                <option value="9">Oktabr</option>
                                <option value="10">Noyabr</option>
                                <option value="11">Dekabr</option>
                            </select>
                            <select id="year-select"></select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-state" style="text-align: center; padding: 40px; color: #666;">
                <p>Talabalar yuklanmoqda...</p>
            </div>

            <!-- Attendance Table -->
            <div class="table-container" id="table-container" style="display: none;">
                <div id="table-content">
                    <!-- Table will be generated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const groupId = {{ group.id }};
        const lessonDays = "{{ group.lesson_days }}"; // "mo we fri" or "tu thu sa"
        let students = [];
        let attendance = {};
        let lessonDates = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeYearSelect();
            setCurrentDate();
            loadStudentsFromAPI();
        });

        // Load students from API
        async function loadStudentsFromAPI() {
            try {
                const response = await fetch(`/manager/api/groups/${groupId}/students/`);
                
                if (!response.ok) {
                    throw new Error(`API xatolik: ${response.status}`);
                }
                
                const apiStudents = await response.json();
                
                // Convert API data to internal format
                students = apiStudents.map(student => ({
                    id: student.id,
                    name: student.full_name,
                    joinDate: new Date().toISOString().split('T')[0] // Default bugungi sana
                }));
                
                console.log('Yuklangan talabalar:', students);
                
                // Hide loading, show table
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('table-container').style.display = 'block';
                
                updateLessonDates();
                await loadExistingAttendance(); // Mavjud davomatlarni yuklash
                renderTable();
                updateStats();
                
            } catch (error) {
                console.error('Xatolik:', error);
                document.getElementById('loading-state').innerHTML = `
                    <p style="color: red;">❌ Talabalarni yuklashda xatolik: ${error.message}</p>
                `;
            }
        }

        // Load existing attendance from backend
        async function loadExistingAttendance() {
            try {
                // Tanlangan oy boshlanishi va oxiri
                const startDate = new Date(currentYear, currentMonth, 1).toISOString().split('T')[0];
                const endDate = new Date(currentYear, currentMonth + 1, 0).toISOString().split('T')[0];
                
                const response = await fetch(
                    `/manager/api/attendance/?group=${groupId}&start_date=${startDate}&end_date=${endDate}`
                );
                
                if (response.ok) {
                    const attendanceData = await response.json();
                    console.log('Yuklangan davomat:', attendanceData);
                    
                    // Davomatlarni object'ga joylashtirish
                    attendanceData.forEach(item => {
                        const date = item.date_time.split('T')[0]; // ISO formatdan sana olish
                        const key = `${item.student}-${date}`;
                        attendance[key] = item.is_present;
                    });
                    
                    console.log('Davomat ma\'lumotlari yuklandi:', Object.keys(attendance).length);
                } else {
                    console.log('Davomat ma\'lumotlari topilmadi yoki API yo\'q');
                }
            } catch (error) {
                console.error('Davomatni yuklashda xatolik:', error);
            }
        }

        function initializeYearSelect() {
            const yearSelect = document.getElementById('year-select');
            for (let year = 2020; year <= 2030; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }

        function setCurrentDate() {
            document.getElementById('month-select').value = currentMonth;
            document.getElementById('year-select').value = currentYear;
        }

        document.getElementById('month-select').addEventListener('change', async function() {
            currentMonth = parseInt(this.value);
            updateLessonDates();
            await loadExistingAttendance(); // Yangi oy uchun davomatlarni yuklash
            renderTable();
            updateStats();
        });

        document.getElementById('year-select').addEventListener('change', async function() {
            currentYear = parseInt(this.value);
            updateLessonDates();
            await loadExistingAttendance(); // Yangi yil uchun davomatlarni yuklash
            renderTable();
            updateStats();
        });

        function getLessonDaysNumbers() {
            const dayMap = {
                'mo': 1,
                'tu': 2,
                'we': 3,
                'thu': 4,
                'fri': 5,
                'sa': 6,
            };
            
            const days = lessonDays.toLowerCase().split(' ');
            return days.map(day => dayMap[day]).filter(Boolean);
        }

        function getWeekdays(month, year) {
            const dates = [];
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const allowedDays = getLessonDaysNumbers();
            
            console.log('Allowed lesson days:', allowedDays);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                
                if (allowedDays.includes(dayOfWeek)) {
                    dates.push({
                        date: date.toISOString().split('T')[0],
                        display: `${day.toString().padStart(2, '0')}.${(month + 1).toString().padStart(2, '0')}`,
                        dayOfMonth: day,
                        dayOfWeek: dayOfWeek,
                        fullDate: date
                    });
                }
            }
            
            console.log(`Found ${dates.length} lesson days for ${month + 1}/${year}`);
            return dates;
        }

        function updateLessonDates() {
            lessonDates = getWeekdays(currentMonth, currentYear);
            
            students.forEach(student => {
                lessonDates.forEach(dateObj => {
                    const key = `${student.id}-${dateObj.date}`;
                    if (!(key in attendance)) {
                        const studentJoinDate = new Date(student.joinDate);
                        const lessonDate = new Date(dateObj.date);
                        
                        if (lessonDate >= studentJoinDate) {
                            attendance[key] = null;
                        }
                    }
                });
            });
        }
        function markAttendance(studentId, date, status) {
            const key = `${studentId}-${date}`;
            attendance[key] = status;
            renderTable();
            updateStats();
            
            // Darhol saqlaymiz (har bir o'zgarishni alohida)
            saveSingleAttendance(studentId, date, status);
        }
        
        // Bitta davomatni saqlash
        async function saveSingleAttendance(studentId, date, status) {
            try {
                const response = await fetch("/manager/api/attendance/save/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    body: JSON.stringify({ 
                        attendance: [{
                            student: parseInt(studentId),
                            group: groupId,
                            date_time: date,
                            is_present: status
                        }]
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    console.log(`✅ Saqlandi: Student ${studentId}, ${date}, ${status ? 'Bor' : 'Yo\'q'}`);
                } else {
                    console.error("❌ Xatolik:", result);
                }
            } catch (error) {
                console.error("❌ Serverga ulanishda xatolik:", error);
            }
        }
        function getAttendanceStats(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return { present: 0, absent: 0, total: 0, percentage: 0 };
            
            const studentJoinDate = new Date(student.joinDate);
            
            const studentAttendance = Object.entries(attendance)
                .filter(([key]) => key.startsWith(`${studentId}-`))
                .filter(([key, value]) => {
                    const dateFromKey = key.split('-').slice(1).join('-');
                    const lessonDate = new Date(dateFromKey);
                    return lessonDate >= studentJoinDate;
                })
                .map(([, value]) => value);
            
            const present = studentAttendance.filter(a => a === true).length;
            const absent = studentAttendance.filter(a => a === false).length;
            const total = present + absent;
            
            return { 
                present, 
                absent, 
                total, 
                percentage: total > 0 ? Math.round((present / total) * 100) : 0 
            };
        }

        function renderTable() {
            const tableContent = document.getElementById('table-content');
            
            if (students.length === 0) {
                tableContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                        </div>
                        <h3 class="empty-title">Hozircha o'quvchilar yo'q</h3>
                        <p class="empty-description">Bu guruhda talabalar mavjud emas</p>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th style="min-width: 200px;">O'quvchi</th>
                                ${lessonDates.map(dateObj => `
                                    <th style="text-align: center; min-width: 80px;">
                                        <div style="font-size: 0.875rem; font-weight: 500;">${dateObj.display}</div>
                                    </th>
                                `).join('')}
                                <th style="text-align: center; min-width: 100px;">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${students.map((student, index) => {
                                const stats = getAttendanceStats(student.id);
                                return `
                                    <tr style="background-color: ${index % 2 === 0 ? 'white' : '#fafafa'};">
                                        <td>
                                            <div class="student-name">${student.name}</div>
                                            <div class="join-date">${new Date(student.joinDate).toLocaleDateString('uz-UZ')} dan</div>
                                        </td>
                                        ${lessonDates.map(dateObj => {
                                            const key = `${student.id}-${dateObj.date}`;
                                            const status = attendance[key];
                                            const studentJoinDate = new Date(student.joinDate);
                                            const lessonDate = new Date(dateObj.date);
                                            const isBeforeJoinDate = lessonDate < studentJoinDate;
                                            
                                            if (isBeforeJoinDate) {
                                                return `
                                                    <td class="attendance-cell">
                                                        <div class="attendance-button disabled">
                                                            <span style="color: #9ca3af;">-</span>
                                                        </div>
                                                    </td>
                                                `;
                                            }
                                            
                                            return `
                                                <td class="attendance-cell">
                                                    <div class="attendance-button ${status === true ? 'present' : status === false ? 'absent' : 'empty'}">
                                                        ${status === true ? `
                                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                            </svg>
                                                        ` : status === false ? `
                                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                            </svg>
                                                        ` : ''}
                                                    </div>
                                                    <div class="hover-buttons">
                                                        <button class="hover-btn present" onclick="markAttendance(${student.id}, '${dateObj.date}', true)" title="Bor">
                                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                            </svg>
                                                        </button>
                                                        <button class="hover-btn absent" onclick="markAttendance(${student.id}, '${dateObj.date}', false)" title="Yo'q">
                                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </td>
                                            `;
                                        }).join('')}
                                        <td style="text-align: center;">
                                            <div class="percentage-badge ${stats.percentage >= 80 ? 'high' : stats.percentage >= 60 ? 'medium' : 'low'}">
                                                ${stats.percentage}%
                                            </div>
                                            
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            tableContent.innerHTML = tableHTML;
        }

        function updateStats() {
            document.getElementById('student-count').textContent = `${students.length} o'quvchi`;
            document.getElementById('lesson-count').textContent = `${lessonDates.length} kun`;
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        let touchTimeout;
        
        function handleTouchStart(element) {
            touchTimeout = setTimeout(() => {
                element.querySelector('.hover-buttons').style.display = 'flex';
            }, 300);
        }
        
        function handleTouchEnd(element) {
            clearTimeout(touchTimeout);
            setTimeout(() => {
                element.querySelector('.hover-buttons').style.display = 'none';
            }, 2000);
        }

        document.addEventListener('touchstart', function(e) {
            if (e.target.closest('.attendance-cell')) {
                handleTouchStart(e.target.closest('.attendance-cell'));
            }
        });

        document.addEventListener('touchend', function(e) {
            if (e.target.closest('.attendance-cell')) {
                handleTouchEnd(e.target.closest('.attendance-cell'));
            }
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.attendance-cell')) {
                document.querySelectorAll('.hover-buttons').forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        });
    </script>
</body>
</html>
